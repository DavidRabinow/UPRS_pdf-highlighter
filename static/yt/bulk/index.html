<!DOCTYPE html>
<html>
    <head>
        <title>YouTube Bulk Downloader</title>
        <meta name="description" content="Watch (or download) YouTube videos without any ads, for free! (Seriously, no hidden fees or conditions or anything.)">
        <meta name="author" content="Ari Meisels">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/favicon.ico">
        <link rel="stylesheet" href="/style.css">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
    </head>
    <body>
        <div id="navbar" class="mb-4"></div>
        
        <script src="/nav.js"></script>
        
        <div id="container" class="container">
            <h1>Download a large quantity of videos at once</h1>

            <br>
            <br>
            
            <div class="mb-3">
                <label for="url" class="form-label">Option 1: Playlist URL</label>
                <input id="url" class="form-control" maxlength="2000" placeholder="Playlist Link...">
            </div>
            
            <button id="submitPlaylist" class="btn btn-primary" value="Submit" disabled>
                <div id="loadingCirclePlaylist" class="" role="status"></div>
                Video
            </button>
            <button id="submitPlaylistAudio" class="btn btn-secondary" value="Submit" disabled>
                <div id="loadingCirclePlaylistAudio" class="" role="status"></div>
                Audio
            </button>

            <br>
            <br>
            
            <div class="mb-3">
                <label for="bulk" class="form-label">Option 2: List of IDs/Links</label>
                <input id="bulk" class="form-control" placeholder="Video IDs or links, separated by line breaks.">
            </div>
            
            <button id="submitBulk" class="btn btn-primary" value="Submit" disabled>
                <div id="loadingCircleBulk" class="" role="status"></div>
                Video
            </button>
            <button id="submitBulk" class="btn btn-secondary" value="Submit" disabled>
                <div id="loadingCircleBulkAudio" class="" role="status"></div>
                Audio
            </button>
            
            <br>
            <br>

            <input id="password" value="secret_password">

            <br>
            <br>

            <div class="progress">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>

            <div id="warnings" role="alert">
            </div>

            <br>

            <div class="modal fade" id="warningModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="warningModalLabel">Warning!</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Your download of <span id="videoCount">...</span> videos will each be individually downloaded, then packaged, on your device. It is not recommended to do this on a slow internet connection or over cellular data.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button id="downloadPlaylist" type="button" class="btn btn-primary" data-bs-dismiss="modal">Confirm Download</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function getPlaylistId(url) {
                var regExp = /^.*(youtube\.com\/playlist\?list=)([^#&?]*).*/;
                var match = url.match(regExp);
                return (match && match[2]) ? match[2] : false;
            }

            function HTMLError(text) {
                return `<div class="alert alert-danger alert-dismissible fade show" role="alert"> <strong>Error!</strong> ${text} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`;
            }
            
            function HTMLWarn(text) {
                return `<div class="alert alert-warning alert-dismissible fade show" role="alert"> <strong>Warning!</strong> ${text} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`;
            }

            $("#url").on("input", async function() {
                if (!getPlaylistId($("#url").val())) {
                    $("#warnings").html("");
                    $("#submitPlaylist").attr("disabled", true);
                    $("#submitAudioPlaylist").attr("disabled", true);
                    return;
                };

                var valid = await fetch(`/yt/validate/playlist/${getPlaylistId($("#url").val())}/`);
                valid = await valid.json();

                if (valid.success) {
                    $("#warnings").html("");
                    $("#submitPlaylist").attr("disabled", false);
                    $("#submitPlaylistAudio").attr("disabled", false);
                } else {
                    $("#warnings").html(HTMLWarn("The requested video does not exist. If you are sure that it does, please contact me so I can fix this bug."));
                    $("#submitPlaylist").attr("disabled", true);
                    $("#submitPlaylistAudio").attr("disabled", true);
                }
            });

            $("#submitPlaylist").on("click", async function() {
                $("#loadingCirclePlaylist").addClass("spinner-border spinner-border-sm text-light");

                var ids = await fetch(`/yt/bulk/playlist/${getPlaylistId($("#url").val())}/${$("#password").val()}/`);
                ids = await ids.json();

                $("#loadingCirclePlaylist").removeClass("spinner-border spinner-border-sm text-light");

                if (ids.success) {
                    $("#videoCount").html(ids ? ids.results ? ids.results.length : "..." : "...");
                    if (ids.results.length > 1) return $("#warningModal").modal("toggle");

                    $("#warnings").html(HTMLError("There has been an unexpected error in the server. Please contact me so I can look further into the issue."));
                } else {
                    $("#warnings").html(HTMLWarn("The requested video does not exist. If you are sure that it does, please contact me so I can fix this bug."));
                    $("#submitPlaylist").attr("disabled", true);
                    $("#submitPlaylistAudio").attr("disabled", true);
                }
            });

            $("#submitPlaylistAudio").on("click", async function () {
                $("#loadingCirclePlaylistAudio").addClass("spinner-border spinner-border-sm text-light");

                var url = await fetch(`/yt/bulk/playlist/${getPlaylistId($("#url").val())}/${$("#password").val()}/`);
                url = await url.json();

                $("#loadingCirclePlaylistAudio").removeClass("spinner-border spinner-border-sm text-light");

                if (url.success) {
                    if (url.formats.audio) return window.open(url.formats.audio);
                    $("#warnings").html(HTMLError("There has been an unexpected error in the server. Please contact me so I can look further into the issue."));
                } else {
                    $("#warnings").html(HTMLWarn("The requested video does not exist. If you are sure that it does, please contact me so I can fix this bug."));
                    $("#submitPlaylist").attr("disabled", true);
                    $("#submitPlaylistAudio").attr("disabled", true);
                }
            });

            $("#downloadPlaylist").on("click", async function() {
                $("#container").find("*").attr("disabled", true);

                setInterval(() => {
                    var currentWidth = $("#progressBar").width();
                    console.log(currentWidth)
                    //$("#progressBar").animate({width: (currentWidth + 1)})
                    //$("#progressBar").html(`${$("#progressBar").width()}%`)
                }, 1)
            });

            $(document).keypress(function(event) {
                if ((event.keyCode ? event.keyCode : event.which) == "13") {
                    $("#submit").click();
                }
            });
        </script>
    </body>
</html>