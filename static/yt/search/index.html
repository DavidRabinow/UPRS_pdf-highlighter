<!DOCTYPE html>
<html>
    <head>
        <title>YouTube Ad-Free</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="https://avatars3.githubusercontent.com/u/68653653?s=48&v=4">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://malsup.github.io/jquery.blockUI.js"></script>
    </head>
    <body id="body">
        <div id="navbar" class="mb-4"></div>
        
        <script src="/nav.js"></script>
        
        <div class="container">
            <h1>Search YouTube</h1>
            
            <div class="mb-3">
                <label for="search" class="form-label">Search Term <span style="color: #ff2825">*</span></label>
                <input id="search" class="form-control" maxlength="2000" placeholder="Search Query...">
            </div>
            
            <button id="submit" class="btn btn-primary" value="Submit" disabled>
                <div id="loadingCircle" class="" role="status"></div>
                Search!
            </button>
            
            <br>
            <br>

            <div id="warnings" role="alert"></div>

            <br>
            <br>

            <div id="videos" class="row">
            </div>
        </div>
        
        <style>
            code {
                background-color: lightgray;
            }
        </style>

        <script>
            var page = 0;
            var next = "";
            var search;

            function httpGet(path, callback) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("GET", path, true);
                xmlHttp.send(null);
                xmlHttp.onload = function() {
                    callback(xmlHttp.responseText);
                }
            }

            function HTMLError(text) {
                return "<div class='alert alert-danger alert-dismissible fade show' role='alert'> <strong>Error!</strong> " + text + " <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button> </div>";
            }
            
            function HTMLWarn(text) {
                return "<div class='alert alert-warning alert-dismissible fade show' role='alert'> <strong>Warning!</strong> " + text + " <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button> </div>";
            }
            
            function HTMLSuccess(text) {
                return "<div class='alert alert-success alert-dismissible fade show' role='alert'> <strong>Success!</strong> " + text + " <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button> </div>";
            }

            function buildCard(data) {
               var grid = document.createElement("div");
               grid.setAttribute("class", "col-sm-6");
               grid.setAttribute("style", "width: 30% !important");
               var card = document.createElement("div");
               card.setAttribute("class", "card");
               card.setAttribute("style", "width: 18rem");
               var image = document.createElement("img");
               image.setAttribute("src", `https://i.ytimg.com/vi/${data.id}/hqdefault.jpg`);
               image.setAttribute("class", "card-img-top");
               image.setAttribute("alt", decodeURIComponent(data.title));
               var body = document.createElement("div");
               body.setAttribute("class", "card-body");
               var title = document.createElement("h5");
               title.setAttribute("class", "card-title")
               title.setAttribute("title", decodeURIComponent(data.title));
               var titleText = document.createTextNode(decodeURIComponent(data.title));
               title.appendChild(titleText);
               var author = document.createElement("p");
               author.setAttribute("class", "card-text");
               author.setAttribute("title", decodeURIComponent(data.author));
               var authorText = document.createTextNode(decodeURIComponent(data.author));
               author.appendChild(authorText);
               var description = document.createElement("p");
               description.setAttribute("class", "card-text");
               description.setAttribute("title", decodeURIComponent(data.description));
               description.setAttribute("style", "font-size: x-small");
               var descriptionText = document.createTextNode(decodeURIComponent(data.description));
               description.appendChild(descriptionText)
               var url = document.createElement("a");
               url.setAttribute("href", data.url);
               url.setAttribute("class", "btn btn-primary");
               url.setAttribute("target", "_blank");
               var urlText = document.createTextNode("Watch");
               url.appendChild(urlText);
               var yturl = document.createElement("a");
               yturl.setAttribute("href", `https://youtu.be/${data.id}/`);
               yturl.setAttribute("class", "btn btn-secondary");
               yturl.setAttribute("style", "float: right");
               yturl.setAttribute("target", "_blank");
               yturlText = document.createTextNode("Open in YouTube");
               yturl.appendChild(yturlText);
               body.appendChild(title);
               body.appendChild(author);
               body.appendChild(description);
               body.appendChild(url);
               body.appendChild(yturl);
               card.appendChild(image);
               card.appendChild(body);
               grid.appendChild(card);
               document.getElementById("videos").appendChild(grid);
            }

            $("#search").on("input", function() {
                if (document.getElementById("search").value) {
                    document.getElementById("submit").disabled = false;
                } else {
                    document.getElementById("submit").disabled = true;
                }
            });

            document.getElementById("submit").addEventListener("click", function () {
                search = document.getElementById("search").value;
                $.blockUI();
                document.getElementById("body").style.overflow = "hidden";

                document.getElementById("loadingCircle").className = "spinner-border spinner-border-sm text-light";
                document.getElementById("submit").disabled = true;

                document.getElementById("videos").innerHTML = "";

                httpGet(`/yt/search/${document.getElementById("search").value}/`, function (res) {
                    res = JSON.parse(res);

                    if (res.success) {
                        var results = res.results;

                        next = res.next || "";

                        for (var i = 0; i < 25; i++) {
                            (function(i) {
                                httpGet(`/yt/getInfo/all/${results[i]}/`, function (res) {
                                    if ((i == 24) || !(results[i + 1])) {
                                        document.getElementById("loadingCircle").className = "";
                                        document.getElementById("submit").disabled = false;
                                        $.unblockUI();
                                        document.getElementById("body").style.overflow = "visible";
                                        return;
                                    } else {
                                        res = JSON.parse(res);
                                        if (res.title.length > 45) {
                                            res.title = res.title.substr(0, 45) + "...";
                                        }

                                        if (res.author.length > 32) {
                                            res.author = res.author.substr(0, 32) + "...";
                                        }
                                        
                                        if (res.description.length > 100) {
                                            res.description = res.description.substr(0, 100) + "...";
                                        }

                                        buildCard({ "id": results[i], "url": res.url, "author": res.author, "title": res.title, "description": res.description, "thumb": res.thumb});
                                    }
                                });
                            })(i);
                        }

                        page++;
                    } else {
                        document.getElementById("warnings").innerHTML = HTMLWarn("Because of stupid quotas on YouTube, this search thingy will not work for the rest of the day. Sorry!");
                        document.getElementById("submit").disabled = true;
                    }
                });
            });

            $(document).keypress(function(event) {
                if ((event.keyCode ? event.keyCode : event.which) == "13") {
                    document.getElementById("submit").click();
                }
            });

            $(window).scroll(function() {
                if ($(window).scrollTop() + $(window).height() == $(document).height()) {
                    $.blockUI();
                    document.getElementById("body").style.overflow = "hidden";

                    document.getElementById("loadingCircle").className = "spinner-border spinner-border-sm text-light";
                    document.getElementById("submit").disabled = true;

                    httpGet(`/yt/search/${search}/${next}/`, function (res) {
                        res = JSON.parse(res);

                        if (res.success) {
                            var results = res.results;

                            next = res.next || "";

                            for (var i = 0; i < 25; i++) {
                                (function(i) {
                                    httpGet(`/yt/getInfo/all/${results[i]}/`, function (res) {
                                        if ((i == 24) || !(results[i + 1])) {
                                            document.getElementById("loadingCircle").className = "";
                                            document.getElementById("submit").disabled = false;
                                            $.unblockUI();
                                            document.getElementById("body").style.overflow = "visible";
                                            return;
                                        } else {
                                            res = JSON.parse(res);
                                            if (res.title.length > 45) {
                                                res.title = res.title.substr(0, 45) + "...";
                                            }

                                            if (res.author.length > 32) {
                                                res.author = res.author.substr(0, 32) + "...";
                                            }
                                            
                                            if (res.description.length > 100) {
                                                res.description = res.description.substr(0, 100) + "...";
                                            }

                                            buildCard({ "id": results[i], "url": res.url, "author": res.author, "title": res.title, "description": res.description, "thumb": res.thumb});
                                        }
                                    });
                                })(i);
                            }

                            page++;
                        } else {
                            document.getElementById("warnings").innerHTML = HTMLWarn("Because of stupid quotas on YouTube, this search thingy will not work for the rest of the day. Sorry!");
                            document.getElementById("submit").disabled = true;
                        }
                    });
                }
            });
        </script>
    </body>
</html>