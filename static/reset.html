<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>Reset Password</title>
        <meta name="description" content="The website of Ari Meisels">
        <meta name="author" content="Ari Meisels">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/favicon.ico">
        <link rel="stylesheet" href="/style.css">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
    </head>
    
    <body>
        <div class="container">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="resetLabel">Reset Password</h5>
                    </div>
                    <div class="modal-body">
                        <div class="input-group flex-nowra mb-3">
                            <span class="input-group-text" id="usernameIcon"><i class="bi bi-person-circle"></i></span>
                            <input class="form-control" id="username" placeholder="Username" aria-label="username" area-descibedby="usernameIcon" disabled>
                        </div>

                        <div class="input-group flex-nowra mb-3">
                            <span class="input-group-text" id="codeIcon"><i class="bi bi-lock-fill"></i></span>
                            <input class="form-control" id="code" placeholder="Code" aria-label="code" area-descibedby="codeIcon" disabled>
                        </div>
        
                        <div id="response" class="mb-3"></div>
                    </div>
        
                    <div class="modal-footer">
                        <button id="resetBtn" type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            var params = new URLSearchParams(window.location.search);

            if (params.get("u")) $("#username").val(params.get("u"));
            if (params.get("c")) $("#code").val(params.get("c"));
            if (!params.get("u")) $("#username").attr("disabled", false);
            if (!params.get("c")) $("#code").attr("disabled", false);
            if (!params.get("u") || !params.get("c")) $("#resetBtn").attr("disabled", true); 

            function HTMLError(text) {
                return `<div class="alert alert-danger alert-dismissible fade show" role="alert"> <strong>Error!</strong> ${text} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`;
            }
            
            function HTMLWarn(text) {
                return `<div class="alert alert-warning alert-dismissible fade show" role="alert"> <strong>Warning!</strong> ${text} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`;
            }
            
            $("#username").on("input", function () {
                $("#resetBtn").attr("disabled", true);
                if (!!$("#username").val() && !!$("#code").val()) $("#resetBtn").attr("disabled", false);
            });
            
            $("#code").on("input", function () {
                $("#resetBtn").attr("disabled", true);
                if (!!$("#username").val() && !!$("#code").val()) $("#resetBtn").attr("disabled", false);
            });

            $("#resetBtn").on("click", async function () {
                const errors = (err) => {
                    switch (err) {
                        case "ratelimit": return "Only one account can be created every 15 minutes.";
                        case "long": return `Username "${$("#login-username").val()}" is too long.`;
                        case "invalidchar": return `Username "${$("#login-username").val()}" contains invalid characters.`;
                        case "invalidemail": return `Email "${$("#login-email").val()}" is invalid.`;
                        case "reserved": return `Username "${$("#login-username").val()}" is reserved.`;
                        case "taken": return `Username "${$("#login-username").val()}" has been taken.`;
                        case "emailused": return `Email "${$("#login-email").val()}" is already linked to an account.`;
                        case "noaccount": return `Username "${$("#login-username").val()}" does not exist.`;
                        case "wrongpass": return `Password "${$("#login-password").val()}" is incorrect.`;
                        case "noaccountlinked": return `Email "${$("#login-email").val()}" not linked to any account.`;
                        case "wrongcode": return "Access code incorrect.";
                    }
                };

                if (!$("#username").val()) return $("#response").html(HTMLError("You must enter the username linked to your account."));

                var response = await fetch(`/reset/${$("#username").val()}/${$("#code").val()}/`);
                var res = await response.json();
                
                if (!res.success) {
                    $("#response").html(HTMLError(errors(res.message)));
                } else {
                    $("#response").html(`<div class="alert alert-success alert-dismissible fade show" role="alert"> <strong>Success!</strong> Your new password is ${res.password}. </div>`);
                }
            });

            $(document).keypress(function (event) {
                if ((event.keyCode ? event.keyCode : event.which) == "13") {
                    $("#resetBtn").click();
                }
            });
        </script>
    </body>
</html>